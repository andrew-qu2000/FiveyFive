<!DOCTYPE HTML>
<html>
<head>
<style>
.wrapper {
  display: grid;
  grid-template-columns: 1fr 100px 1fr;
  gap: 10px;
  grid-auto-rows: minmax(100px, auto);
}
div {
  font-family: verdana;
  font-size: 20px;
  color: white;
}
div.blue {
  grid-column: 1;
  background-color: #67a9cf;
}
div.PlayerCard {
  height: 100px;
}
span.PlayerInfo {
  line-height: 100px;
}
div.PositionCol {
  grid-column: 2;
  background-color: gray;
  text-align: center;
  line-height: 100px;
}
div.red {
  grid-column: 3;
  background-color: #ef8a62;
  text-align: left;
}
.top {
  grid-row: 1;
}
.jun {
  grid-row: 2;
}
.mid {
  grid-row: 3;
}
.bot {
  grid-row: 4;
}
.sup {
  grid-row: 5;
}
.team {
  grid-row: 6;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.12/lib/draggable.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.12/lib/swappable.js"></script>
<!--<script src="/static/require.js"/>-->
<!--<script src="/static/node_modules/draggable-es/src/Swappable/Swappable.js"></script>-->
</head>

<body>

<div class="wrapper">
  <div class="blue top">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="blue jun">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="blue mid">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="blue bot">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="blue sup">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="blue team">
    <span id="blue avg"></span>
  </div>
  <div class="PositionCol">TOP</div>
  <div class="PositionCol">JUN</div>
  <div class="PositionCol">MID</div>
  <div class="PositionCol">BOT</div>
  <div class="PositionCol">SUP</div>
  <div class="PositionCol">AVG</div>
  <div class="red top">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="red jun">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="red mid">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="red bot">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="red sup">
    <div class="PlayerCard">
    </div>
  </div>
  <div class="red team">
    <span id="red avg"></span>
  </div>
</div>
<script>
class Player{
  constructor(uniqueId, dict){
    this.uniqueId = uniqueId;
    this.name = dict["name"];
    // Need to generalize this to other games and positions
    this.top = dict["rating_top"];
    this.jun = dict["rating_jun"];
    this.mid = dict["rating_mid"];
    this.bot = dict["rating_bot"];
    this.sup = dict["rating_sup"];
  }
}
</script>
<script>
var playerData = {'0ZVOrdkATvILql9FpkZQ': {'name': 'Terence', 'rating_bot': 68, 'rating_sup': 60, 'rating_top': 69, 'rating_mid': 77, 'rating_jun': 66}, '1aW8rXTsGeSHoenjNBll': {'name': 'Jordon', 'rating_bot': 75, 'rating_jun': 75, 'rating_mid': 75, 'rating_top': 75, 'rating_sup': 75}, '1kZJphp8mKFhrppR7Z6N': {'rating_top': 65, 'rating_bot': 82, 'rating_jun': 75, 'name': 'Aymen', 'rating_mid': 65, 'rating_sup': 83}, '4Ef1LJadnxxRye3FGmmh': {'rating_bot': 96, 'rating_mid': 89, 'name': 'Sean', 'rating_top': 88, 'rating_jun': 93, 'rating_sup': 91}, '8aib8bcmnSdMoMRkBiM9': {'rating_bot': 69, 'rating_jun': 62, 'rating_mid': 60, 'name': 'Cameron', 'rating_sup': 55, 'rating_top': 60}, 'AwretIU7qfSCfuh3LWzw': {'rating_jun': 94, 'rating_sup': 85, 'rating_mid': 80, 'rating_bot': 72, 'name': 'Nick', 'rating_top': 78}, 'BKLQRAibwubvzYGIOeXI': {'rating_mid': 83, 'rating_sup': 85, 'rating_top': 84, 'name': 'Gavin', 'rating_bot': 82, 'rating_jun': 85}, 'BcuqGG8zc1rRnjWGRiHn': {'rating_top': 83, 'rating_jun': 80, 'name': 'Matthew', 'rating_bot': 65, 'rating_sup': 71, 'rating_mid': 73}, 'GV104QxHvtMdXTdmkGVy': {'rating_jun': 85, 'rating_bot': 85, 'rating_top': 92, 'rating_sup': 86, 'rating_mid': 86, 'name': 'Andrew'}, 'NvMsemlWHB8YyrsArDjZ': {'name': 'Alex', 'rating_bot': 62, 'rating_top': 70, 'rating_sup': 68, 'rating_jun': 69, 'rating_mid': 70}, 'QqjolTCT2oAuePGWeZrZ': {'rating_top': 92, 'rating_bot': 90, 'rating_jun': 87, 'rating_sup': 88, 'name': 'Jason', 'rating_mid': 95}, 'SGB1pMWotCzZNdPISJwV': {'rating_top': 64, 'rating_jun': 67, 'rating_mid': 77, 'rating_bot': 67, 'name': 'Jiajun', 'rating_sup': 66}, 'T3TjvcGdJvd6CoIKpWiw': {'rating_mid': 55, 'rating_sup': 65, 'rating_top': 55, 'rating_bot': 55, 'name': 'Justin', 'rating_jun': 55}, 'XxfRSrDU9BdRhIZYVu7Z': {'rating_sup': 84, 'rating_top': 80, 'rating_bot': 82, 'name': 'Eric', 'rating_mid': 83, 'rating_jun': 82}, 'isEYfiYW1FoBLfGoE4hZ': {'rating_jun': 70, 'rating_sup': 74, 'name': 'Leo', 'rating_bot': 64, 'rating_top': 76, 'rating_mid': 63}, 'kUOTZAI40ANono9zrNps': {'name': 'Gordon Lei', 'rating_sup': 99, 'rating_mid': 99, 'rating_bot': 99, 'rating_top': 99, 'rating_jun': 99}, 'nhyqjZSTzao5IVCJfWGE': {'rating_sup': 76, 'rating_top': 85, 'name': 'Andre', 'rating_jun': 89, 'rating_mid': 81, 'rating_bot': 80}, 'pQrFvDq2IhOYq7hSvB7M': {'rating_mid': 87, 'name': 'Kent', 'rating_top': 84, 'rating_jun': 84, 'rating_sup': 81, 'rating_bot': 75}, 'x4ykk2sHjspi5RBsyQFH': {'rating_top': 75, 'rating_bot': 76, 'rating_jun': 79, 'name': 'Daniel', 'rating_mid': 74, 'rating_sup': 95}};
var playerCards = document.getElementsByClassName("PlayerCard");
var blueRatings = {};
var redRatings = {};

function addToEmptyPlayerCard(playerObj, playerCardsInd){
  var newPlayerInfo = document.createElement("span");
  newPlayerInfo.classList.add("PlayerInfo");
  newPlayerInfo.innerHTML = playerObj.name + "\t";
  newPlayerInfo.setAttribute("data-uniqueId", playerObj.uniqueId);
  var pos = playerCards[playerCardsInd].parentElement.classList;
  var playerRating;
  playerCards[playerCardsInd].appendChild(newPlayerInfo);
  // Need to generalize this to other games and positions
  switch(pos[1]){
    case 'top':
      newPlayerInfo.innerHTML += playerObj.top;
      playerRating = playerObj.top;
      break;
    case 'jun':
      newPlayerInfo.innerHTML += playerObj.jun;
      playerRating = playerObj.jun;
      break;
    case 'mid':
      newPlayerInfo.innerHTML += playerObj.mid;
      playerRating = playerObj.mid;
      break;
    case 'bot':
      newPlayerInfo.innerHTML += playerObj.bot;
      playerRating = playerObj.bot;
      break;
    case 'sup':
      newPlayerInfo.innerHTML += playerObj.sup;
      playerRating = playerObj.sup;
      break;
  }

  if (pos[0] == "blue") {
    blueRatings[pos[1]] = playerRating;
  }
  else {
    redRatings[pos[1]] = playerRating;
  }
}
// Initializes grid. Adds players until full
var i = 0;
var playerDataArr = Object.entries(playerData);
while (i < playerCards.length) {
  var keyVal= playerDataArr[i];
  addToEmptyPlayerCard(new Player(keyVal[0],keyVal[1]), i);
  i += 1;
}
updateAverages();

// Updates the rating of the dragging source based on new position being hovered
function updatePlayerCardRating(swappedPlayerCard, isMirror=false){
  if (isMirror) {
    var newDbPos = "rating_" + document.getElementsByClassName("draggable-container--over")[0].classList[1];
  }
  else {
    var newColorAndPos = swappedPlayerCard.parentElement.classList;
    console.log(swappedPlayerCard.firstElementChild.innerHTML);
    var newDbPos = "rating_" + newColorAndPos[1];
  }
  var playerInfo = swappedPlayerCard.firstElementChild;
  var name = playerData[playerInfo.dataset.uniqueid]["name"];
  var newRating = playerData[playerInfo.dataset.uniqueid][newDbPos];
  playerInfo.innerHTML = name + "\t" + newRating;

  if (newColorAndPos) {
    if (newColorAndPos[0] == 'blue') {
      blueRatings[newColorAndPos[1]] = newRating;
    }
    else {
      redRatings[newColorAndPos[1]] = newRating;
    }
    updateAverages();
  }

}

function updateByContainer(container){
  updatePlayerCardRating(container.firstElementChild);
}

function updateAverages() {
  var blueavg = Object.values(blueRatings).reduce(function(a,b) {return a + b;}, 0) / Object.keys(blueRatings).length;
  var redavg = Object.values(redRatings).reduce(function(a,b) {return a + b;}, 0) / Object.keys(redRatings).length;
  document.getElementById("blue avg").innerHTML = blueavg;
  document.getElementById("red avg").innerHTML = redavg;
}

const swappable = new Swappable.default(document.querySelectorAll('.blue, .red'), {
  draggable: '.PlayerCard'
});

swappable.on('swappable:start', function(){
  console.log('swappable:start');
})

var originalContainer;
var swappingContainer;

// Is called any time elements swap places while hovering (similar to drag:over?)
swappable.on('swappable:swapped', function(e){
  console.log('swappable:swapped');
  // update source element and its mirror
  updatePlayerCardRating(document.getElementsByClassName("draggable-source--is-dragging")[0]);
  updatePlayerCardRating(document.getElementsByClassName("draggable-mirror")[0], true);
  // update element that gets swapped with
  if (swappingContainer) {
    updateByContainer(swappingContainer);
  }
  // handles first swap, when swappingContainer will be none
  // or when more than one element gets passed over during one swap
  updatePlayerCardRating(e.swappedElement);
  // maintain latest swapped elements to use in drag:stopped
  originalContainer = document.getElementsByClassName("draggable-container--is-dragging")[0];
  swappingContainer = document.getElementsByClassName("draggable-container--over")[0];
});

// Gets fired when draggable finished (Added in: v1.0.0-beta.12)
swappable.on('drag:stopped', function(){
  console.log('drag:stopped');
  // update the two elements being swapped when cursor is released
  updateByContainer(swappingContainer);
  updateByContainer(originalContainer);
  //updateAverages();
});

// Solution(?)
</script>
</body>
</html>
